<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel - CondoApp</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1B4D72">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="CondoApp">
  <link rel="apple-touch-icon" href="attached_assets/CondoApp_1750367572078.png">
  <link rel="manifest" href="manifest.json">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="style.css">
  <style>
    .navbar-toggler {
      border-color: rgba(255,255,255,0.5);
    }
    .navbar-toggler-icon {
      background-image: url("data:image/svg+xml;charset=utf8,%3Csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke='rgba%28255,255,255,1%29' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3E%3C/svg%3E");
    }
    body {
      background: #f8f9fa;
      min-height: 100vh;
      margin: 0;
    }

    .center-content {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      z-index: 1000;
    }

    .logo {
      width: 100px;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .offcanvas-header {
      background: #007bff;
      color: #fff;
    }
    .offcanvas-title {
      font-weight: bold;
    }
    /* Botão de refresh */
    .refresh-btn {
      color: #fff;
      background: none;
      border: none;
      font-size: 1.7rem;
      margin-left: 10px;
      cursor: pointer;
      transition: color 0.2s;
    }
    /*.refresh-btn:hover {
      color: #0056b3;*/
    }
  </style>
</head>
<body>
  <!-- Navbar com menu hambúrguer -->
  <nav class="navbar navbar-light bg-primary">
    <div class="container-fluid flex-column align-items-stretch">
      <!-- Primeira linha: menu hamburguer + CondoApp -->
      <div class="d-flex align-items-center w-100">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-flex align-items-center">
        <div class="ms-3">
          <span class="fs-3 fw-bold text-white">CondoApp</span>
        </div>
      </div>
      </div>
      <!-- Segunda linha: Olá + ícone de saída + refresh -->
      <div class="d-flex align-items-center justify-content-end w-100 mt-1">
        <span class="text-white me-3">Olá, <span id="userName"></span>!</span>
        <div id="messageIcons" class="d-flex align-items-center">
          <a href="mensagens-texto.html" title="Enviar Mensagem Rápida" class="mx-2" style="color: #fff; font-size: 1.7rem;">
            <i class="bi bi-lightning"></i>
          </a>
          <a href="mensagem-convencional.html" title="Enviar Mensagem Convencional" class="mx-2" style="color: #fff; font-size: 1.7rem;">
            <i class="bi bi-envelope"></i>
          </a>
          </div>
        <button class="refresh-btn mx-2" id="refreshBtn" title="Atualizar mensagens">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
        <a href="#" onclick="logout()" title="Sair" class="mx-2" style="color: #fff; font-size: 1.7rem;">
          <i class="bi bi-box-arrow-right"></i>
        </a>
      </div>
    </div>
  </nav>

  <!-- Offcanvas/hambúrguer menu -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasMenuLabel">Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body">
      <h6 class="text-muted mb-3">Cadastros</h6>
      <ul class="list-unstyled mb-0">
        <li><a href="usuarios-list.html" class="menu-link d-block py-2 px-3 text-decoration-none">Usuários</a></li>
        <li><a href="blocos-list.html" class="menu-link d-block py-2 px-3 text-decoration-none">Blocos</a></li>
        <li><a href="agrupadores-list.html" class="menu-link d-block py-2 px-3 text-decoration-none">Agrupadores</a></li>
        <li><a href="unidades-list.html" class="menu-link d-block py-2 px-3 text-decoration-none">Unidades</a></li>
        <li><a href="grupos-list.html" class="menu-link d-block py-2 px-3 text-decoration-none">Grupos</a></li>
        <li><a href="tipos-msg-rapidas-list.html" class="menu-link d-block py-2 px-3 text-decoration-none">Tipos de Mensagens Rápidas</a></li>
        <li><a href="msg-rapidas-list.html" class="menu-link d-block py-2 px-3 text-decoration-none">Mensagens Rápidas</a></li>
      </ul>
    </div>
  </div>

  <!-- Tela de boas-vindas (primeira visita) -->
  <div id="welcomeScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1B4D72 0%, #2563EB 100%); z-index: 9999; align-items: center; justify-content: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #fff;">
    <div style="text-align: center; background: white; padding: 3rem 2.5rem; border-radius: 18px; box-shadow: 0 6px 24px rgba(0,0,0,0.15); max-width: 350px;">
      <img src="assets/logo-condoapp.png" alt="CondoApp Logo" style="width: 180px; height: auto; margin: 0 auto 20px; animation: pulse 2s infinite;"
           onerror="this.style.display='none'; document.getElementById('welcomeLogoFallback').style.display='block';">
      <div id="welcomeLogoFallback" style="display: none; color: #1B4D72; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 2rem; font-weight: bold; margin: 0 auto 20px;">
        CondoApp
      </div>
      <h2 style="color: #1B4D72; font-weight: 600; font-size: 1.4rem; margin-bottom: 10px;">Bem-vindo ao CondoApp!</h2>
      <p style="color: #1B4D72; font-weight: 500; opacity: 0.7; margin: 0;">Carregando suas mensagens...</p>
    </div>
  </div>

  <!-- Tela de refresh mobile -->
  <div id="refreshMobileScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1B4D72 0%, #2563EB 100%); z-index: 9999; align-items: center; justify-content: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #fff;">
    <div style="text-align: center; background: white; padding: 3rem 2.5rem; border-radius: 18px; box-shadow: 0 6px 24px rgba(0,0,0,0.15); max-width: 350px;">
      <img src="assets/logo-condoapp.png" alt="CondoApp Logo" style="width: 180px; height: auto; margin: 0 auto 20px; animation: pulse 2s infinite;"
           onerror="this.style.display='none'; document.getElementById('refreshMobileLogoFallback').style.display='block';">
      <div id="refreshMobileLogoFallback" style="display: none; color: #1B4D72; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 2rem; font-weight: bold; margin: 0 auto 20px;">
        CondoApp
      </div>
      <h2 style="color: #1B4D72; font-weight: 600; font-size: 1.4rem; margin-bottom: 10px;"></h2>
      <p style="color: #1B4D72; font-weight: 500; opacity: 0.7; margin: 0;">Carregando suas mensagens...</p>
    </div>
  </div>

  <!-- Tela de refresh (específica para atualizações) -->
  <div id="loadScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1B4D72 0%, #2563EB 100%); z-index: 9999; align-items: center; justify-content: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #fff;">
    <div style="text-align: center; background: white; padding: 3rem 2.5rem; border-radius: 18px; box-shadow: 0 6px 24px rgba(0,0,0,0.15); max-width: 350px;">
      <img src="assets/logo-condoapp.png" alt="CondoApp Logo" style="width: 180px; height: auto; margin: 0 auto 20px; animation: pulse 2s infinite;"
           onerror="this.style.display='none'; document.getElementById('refreshLogoFallback').style.display='block';">
      <div id="refreshLogoFallback" style="display: none; color: #1B4D72; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 2rem; font-weight: bold; margin: 0 auto 20px;">
        CondoApp
      </div>
      <h2 style="color: #1B4D72; font-weight: 600; font-size: 1.4rem; margin-bottom: 10px;"></h2>
      <p style="color: #1B4D72; font-weight: 500; opacity: 0.7; margin: 0;">Carregando suas mensagens...</p>
    </div>
  </div>

  <!-- Lista de mensagens -->
  <div id="messagesListContainer">
    <div class="container mt-4">
      <div class="alert alert-secondary text-center">
        Horário local atual: <span id="localNow"></span>
      </div>
      <div class="card shadow">
        <div class="card-body">
          <h4 class="card-title mb-4">Mensagens Recentes</h4>
          <div id="messagesList" class="list-group">
            <!-- As mensagens serão carregadas dinamicamente pelo JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script.js"></script>
  <script src="push-notifications.js"></script>
  <script>
    // LÓGICA REMOVIDA - Controle centralizado no script.js

    // Função para forçar solicitação de permissão (chamada pelo botão)
    async function forcarPermissaoNotificacao() {
      console.log('🔄 FORÇANDO solicitação de permissão...');

      try {
        const permission = await Notification.requestPermission();
        console.log(`🔔 Resultado: ${permission}`);

        if (permission === 'granted') {
          alert('✅ Notificações ativadas com sucesso!');
          console.log('✅ Sucesso! Recarregando para ativar sistema...');
          localStorage.setItem('condoapp_had_permission', 'true');
          location.reload(); // Recarregar para inicializar o sistema
        } else if (permission === 'denied') {
          alert('❌ Você negou as notificações. Use as configurações do navegador para ativar.');
        } else {
          alert('⚠️ Permissão não foi concedida. Tente novamente.');
        }
      } catch (error) {
        console.error('❌ Erro:', error);
        alert('❌ Erro ao solicitar permissão. Verifique as configurações do navegador.');
      }
    }

    // Sistema de Push Notifications Segmentado - Inicialização Automática
    document.addEventListener('DOMContentLoaded', async function() {
      const user = JSON.parse(localStorage.getItem('user'));

      if (user) {
        // Inicializar sistema de push automaticamente para todos os usuários
        console.log('🚀 Iniciando configuração automática de notificações...');

        setTimeout(async () => {
          try {
            const pushConfigured = await window.pushNotificationManager.init(user);

            if (pushConfigured) {
              console.log('🎉 Sistema de notificações configurado com sucesso');
            } else {
              console.log('⚠️ Sistema de notificações não foi configurado (sem permissão ou erro)');
            }
          } catch (error) {
            console.error('❌ Erro ao configurar notificações:', error);
          }
        }, 500); // Reduzido de 1000ms para 500ms para resposta mais rápida
      }
    });
  </script>

  
</body>
</html>