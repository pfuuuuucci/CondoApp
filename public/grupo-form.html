<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Novo Grupo - CondoApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="style.css">
  <style>
    .navbar .back-btn {
      color: #fff;
      font-size: 1.7rem;
      text-decoration: none;
      margin-left: auto;
    }
    .navbar .back-btn:hover {
      color: #e0e0e0;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-primary">
    <div class="container-fluid d-flex align-items-center">
      <span class="navbar-brand mb-0 h1 text-white">CondoApp</span>
      <a href="#" class="back-btn ms-auto" onclick="goBack()" title="Voltar">
        <i class="bi bi-arrow-left"></i>
      </a>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="card shadow">
      <div class="card-body">
        <h4 class="card-title mb-4">Cadastrar Novo Grupo</h4>
        <form id="grupoForm">
          <div class="mb-3">
            <label class="form-label">Bloco</label>
            <select class="form-select" id="blocoId" required>
              <option value="">Selecione um bloco</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Agrupador</label>
            <select class="form-select" id="agrupadorId" required disabled>
              <option value="">Selecione um agrupador</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Unidades</label>
            <select class="form-select" id="unidades" multiple required>
              <!-- Unidades serÃ£o carregadas via JS -->
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = 'dashboard.html';
      }
    }
    function logout() {
      localStorage.removeItem('user');
      window.location.href = "login.html";
    }

    async function carregarBlocos() {
      const res = await fetch('/api/blocos');
      const blocos = await res.json();
      const select = document.getElementById('blocoId');
      select.innerHTML = '<option value="">Selecione um bloco</option>' + 
        blocos.map(b => `<option value="${b.id}">${b.nome}</option>`).join('');
    }

    async function carregarAgrupadores(blocoId) {
      const res = await fetch('/api/agrupadores');
      const agrupadores = await res.json();
      const select = document.getElementById('agrupadorId');
      const filtrados = agrupadores.filter(a => a.blocoId == blocoId);
      select.innerHTML = '<option value="">Selecione um agrupador</option>' + 
        filtrados.map(a => `<option value="${a.id}">${a.nome}</option>`).join('');
      select.disabled = false;
    }

    async function carregarUnidades() {
      const res = await fetch('/api/unidades');
      const unidades = await res.json();
      const select = document.getElementById('unidades');
      select.innerHTML = unidades.map(u => 
        `<option value="${u.id}">${u.nome}</option>`
      ).join('');
    }

    document.getElementById('blocoId').addEventListener('change', async function() {
      await carregarAgrupadores(this.value);
    });

    document.getElementById('grupoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const blocoId = parseInt(document.getElementById('blocoId').value);
      const agrupadorId = parseInt(document.getElementById('agrupadorId').value);
      const unidades = Array.from(document.getElementById('unidades').selectedOptions)
        .map(option => parseInt(option.value));

      const res = await fetch('/api/grupos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ blocoId, agrupadorId, unidadeIds: unidades })
      });

      if (res.ok) {
        window.location.href = 'grupos-list.html';
      } else {
        const error = await res.json();
        alert(error.error);
      }
    });

    carregarBlocos();
    carregarUnidades();
  </script>
</body>
</html>
